---
title: "Mini-Project 4"
author: "Harriet Brookes-Gray, Ellen Dong, Christina Hung"
date: "April 27, 2019"
output: 
  html_document:
    code_folding: hide
---
```{r, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Opening the libraries, getting scidb data

library(tidyverse)
library(RMySQL)
library(leaflet)
library(sf)

db <- dbConnect(MySQL(), 
                host = "scidb.smith.edu", 
                user = "mth292", 
                password = "RememberPi", 
                dbname = "citibike")
knitr::opts_chunk$set(connection = db, max.print = 20)
```






```{r}
# figuring out the duration by age 
durationbyage <- dbGetQuery(db,
                            "SELECT birth_year, COUNT(user_type) AS total_number_of_subscribers, start_station_id, station_months.name, start_time, trips.stop_time, station_id, avg_lat, avg_lon
                            FROM trips
                            LEFT JOIN station_months ON trips.start_station_id = station_months.station_id
                            WHERE user_type = 'subscriber'
                            AND start_time > '2017-01-01 06:00:00' AND stop_time < '2017-01-01 10:00:00'
                            AND birth_year >= 1945
                            GROUP BY birth_year
                            ORDER BY total_number_of_subscribers DESC
                            LIMIT 5")
durationbyage
```

```{r}
durationbyage_gg <- dbGetQuery(db,
                            "SELECT birth_year, COUNT(user_type) AS total_number_of_subscribers, start_station_id, station_months.name, start_time, trips.stop_time, station_id, avg_lat, avg_lon
                            FROM trips
                            LEFT JOIN station_months ON trips.start_station_id = station_months.station_id
                            WHERE user_type = 'subscriber'
                            AND start_time > '2017-01-01 06:00:00' AND stop_time < '2017-01-01 10:00:00'
                            AND birth_year >= 1945
                            GROUP BY birth_year
                            ORDER BY total_number_of_subscribers DESC")
durationbyage_gg
```

```{r}
duration_plot <- leaflet() %>%
  addTiles() %>%
  addMarkers(data = durationbyage, lng = ~avg_lon, lat = ~avg_lat, popup = ~name)

duration_plot
```

```{r}
duration_ggplot <- ggplot(durationbyage_gg, aes(x = birth_year, y = total_number_of_subscribers)) +
  geom_col() +
  geom_smooth(aes(color = "red")) + 
  labs(title = "How Many Subscribers Are In Each Birth Year?",
       x = "Birth Year",
       y = "Total Number of Subscribers" ) 


duration_ggplot
```

