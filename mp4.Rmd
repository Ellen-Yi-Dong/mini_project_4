---
title: "Mini-Project 4"
author: "Harriet Brookes-Gray, Ellen Dong, Christina Hung"
date: "April 27, 2019"
output: 
  html_document:
    df_print: paged
    code_folding: hide
---
```{r, message = FALSE, warning = FALSE, results = 'hide'}
knitr::opts_chunk$set(echo = TRUE)
#Opening the libraries, getting scidb data

library(tidyverse)
library(RMySQL)
library(leaflet)
library(sf)
library(dplyr)
library(ggplot2)
library(scales)

db <- dbConnect(MySQL(), 
                host = "scidb.smith.edu", 
                user = "mth292", 
                password = "RememberPi", 
                dbname = "citibike")
knitr::opts_chunk$set(connection = db, max.print = 20)
```


```{r, results = 'hide'}
#SQL Query to Join the Tables

dbGetQuery (db,
            "SELECT station_id, name, avg_lat, avg_lon
            FROM trips 
            LEFT JOIN station_months ON trips.start_station_id = station_months.station_id
            WHERE start_time > '2017-01-01 06:00:00' AND stop_time < '2017-01-01 10:00:00'
            GROUP BY station_id
            ORDER BY start_time;")
```

```{r, results = 'hide'}
#SQL Query to Count Unique Bikes (uses bike_id key/index)

dbGetQuery (db,
            "SELECT COUNT(DISTINCT bike_id) AS number_of_bikes
            FROM trips;")
```

```{r, results = 'hide'}
#SQL query to find young subscribers and moving it into R

young_subscribers <- dbGetQuery(db, 
                    "SELECT user_type, COUNT(user_type) AS number_of_users, birth_year
                    FROM trips 
                    WHERE user_type = 'subscriber'
                    AND birth_year > 1980
                    GROUP BY birth_year
                    ORDER BY birth_year DESC;")
```

```{r}
#Plotting proportion of young subscribers

young_subscribers_plot <- ggplot(young_subscribers, aes(x = birth_year, y = number_of_users))
```

```{r, results = 'hide'}
#SQL query to find old subscribers and moving it into R

old_subscribers <- dbGetQuery(db,
                     "SELECT user_type, COUNT(user_type) AS number_of_users, birth_year
                      FROM trips 
                      WHERE user_type = 'subscriber'
                      AND birth_year < 1980
                      GROUP BY birth_year
                      ORDER BY birth_year DESC;")
```


```{r, results = 'hide'}
#creating table for determining the gender of the subscribers

gender_subscribers <- dbGetQuery(db,
                     "SELECT user_type, COUNT(user_type) AS number_of_subscribers, gender
                      FROM trips 
                      WHERE user_type = 'subscriber'
                      AND birth_year BETWEEN 1945 AND 2001
                      AND start_time > '2017-01-01 06:00:00' AND stop_time < '2017-01-01 10:00:00'
                      GROUP BY gender;") 
```

**Graph of the Gender of the Subscribers**
```{r}
#creating the graph of the gender of the subscribers 

cols <- c("0" = "gray", "1" = "deepskyblue2", "2" = "deeppink2")

gender_s <- ggplot(data = gender_subscribers, aes(x = gender, y = number_of_subscribers)) + 
  geom_col(aes(fill = factor(gender))) + 
  labs(title = "The Total Number of Subscribers For Each Gender", 
       x = "Gender", 
       y = "Number of Subscribers", 
       fill = "Gender") +
  scale_x_continuous(breaks = c(0, 1, 2), 
                     labels = c("Unknown/Don't Specify with Either", "Male", "Female")) +
  scale_fill_manual(values = cols, 
                     limits = c("0", "1", "2"), 
                     labels = c("Unknown/Don't Specify with Either", "Male", "Female"))
gender_s
```

```{r, results = 'hide'}
#SQL query to count number of subscribers

count_subscribers <- dbGetQuery(db, 
                          "SELECT birth_year, COUNT(user_type) AS total_number_of_subscribers    
                            FROM trips
                            WHERE user_type = 'subscriber'
AND birth_year >=1945
                           GROUP BY birth_year;")
```

```{r, results = 'hide'}
#SQL query to count number of customers

count_customers <- dbGetQuery(db,
                            "SELECT birth_year, COUNT(user_type) AS total_number_of_customers
                            FROM trips
                            WHERE user_type = 'customer' AND birth_year >= 1945
                            GROUP BY birth_year;")

```

```{r, results = 'hide', message = FALSE}
#Joining the tables that count subscribers and customers

total_users <- count_subscribers %>% full_join(count_customers)
```

**Compare the number of subscribers to customers as whole**

```{r fig.show = "hold", out.width = "50%"}

#Plotting subscribers vs. customers

subs_vs_cus <- ggplot(data = total_users, aes(x = birth_year, y = total_number_of_customers)) +
  geom_col() + 
  geom_line(aes(color = "plum4")) + 
  scale_color_manual(values = c("darkviolet")) + 
  labs(title = "The Total Number of Customers In Each Birth Year Overall", 
       x = "Birth Year", 
       y = "Number of Customers") + 
  theme(legend.position = "none") 


subs_vs_cus2 <- ggplot(data = total_users, aes(x = birth_year, y = total_number_of_subscribers)) +
  geom_col() + 
  geom_line(aes(color = "plum4")) + 
  scale_color_manual(values = c("darkviolet")) + 
  labs(title = "The Total Number of Subscribers In Each Birth Year Overall", 
       x = "Birth Year", 
       y = "Number of Subscribers") + 
  theme(legend.position = "none")

subs_vs_cus
subs_vs_cus2
```

```{r, results = 'hide'}
#SQL query to find top 5 stations by most subscribers (using indexes)

most_subscribers <- dbGetQuery(db,
                            "SELECT birth_year, COUNT(user_type) AS total_number_of_subscribers, start_station_id, station_months.name, start_time, trips.stop_time, station_id, avg_lat, avg_lon
                            FROM trips
                            LEFT JOIN station_months ON trips.start_station_id = station_months.station_id
                            WHERE user_type = 'subscriber'
                            AND start_time > '2017-01-01 06:00:00' AND stop_time < '2017-01-01 10:00:00'
                            AND birth_year >= 1945
                            GROUP BY birth_year
                            ORDER BY total_number_of_subscribers DESC
                            LIMIT 5;")
```

```{r, results = 'hide'}
#SQL query to get top 5 stations by most subscribers into R (using indexes)

most_subscribers_gg <- dbGetQuery(db,
                            "SELECT birth_year, COUNT(user_type) AS total_number_of_subscribers, start_station_id, station_months.name, start_time, trips.stop_time, station_id, avg_lat, avg_lon
                            FROM trips
                            LEFT JOIN station_months ON trips.start_station_id = station_months.station_id
                            WHERE user_type = 'subscriber'
                            AND start_time > '2017-01-01 06:00:00' AND stop_time < '2017-01-01 10:00:00'
                            AND birth_year >= 1945
                            GROUP BY birth_year
                            ORDER BY total_number_of_subscribers DESC;")
```


**Map of Top 5 Bike Stations with Most Subscribers**
```{r}
#Making leaflet of top 5 stations by subscribers

most_subscribers_plot <- leaflet() %>%
  addTiles() %>%
  addMarkers(data = most_subscribers, lng = ~avg_lon, lat = ~avg_lat, popup = ~name)

most_subscribers_plot
```

```{r, message = FALSE}
#Plotting number of subscribers per birth year

most_subscribers_ggplot <- ggplot(most_subscribers_gg, aes(x = birth_year, y = total_number_of_subscribers)) +
  geom_col() +
  geom_smooth(aes(color = "red")) + 
  labs(title = "How Many Subscribers Are In Each Birth Year?",
       x = "Birth Year",
       y = "Total Number of Subscribers") +
  theme(legend.position = "none")

most_subscribers_ggplot
```
